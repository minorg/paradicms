version: 2.1
jobs:
  py:
    docker:
      - image: circleci/python:3.8-node
    steps:
      - checkout
      - run:
          name: "Change system directory permissions"
          command: sudo chown -R circleci:circleci /usr/local/bin /usr/local/lib/python3.8/site-packages
      - restore_cache:
          key: py-dependencies-{{ .Branch }}-{{ checksum "etl/requirements.txt" }}
      - run:
          name: "Install requirements"
          command: pip install -r etl/requirements.txt
      - save_cache:
          key: py-dependencies-{{ .Branch }}-{{ checksum "etl/requirements.txt" }}
          paths:
            - "~/.cache/pip"
            - "/usr/local/bin"
            - "/usr/local/lib/python3.8/site-packages"
      - run:
          name: "Run test data pipeline"
          command: |
            cd etl
            export PYTHONPATH=$PWD
            python3 paradicms_etl/pipelines/test_data_pipeline.py
      - run:
          name: "Run unit tests"
          command: |
            cd etl
            mkdir test-results
            pytest --junitxml=test-results/junit.xml
      - store_test_results:
          path: etl/test-results
  ts:
    docker:
      - image: circleci/python:3.8-node
    steps:
      - checkout
      - restore_cache:
          key: ts-cache-v4-{{ checksum "package.json" }}-{{ checksum "gui/union/package.json" }}-{{ checksum "lib/ts/base/package.json" }}-{{ checksum "lib/ts/material-ui/package.json" }}-{{ checksum "lib/ts/models/package.json" }}
#      - run:
#          name: Clean out cache
#          command: |
#            rm -fr ~/.cache
#            rm -fr ~/.npm
#            rm -fr node_modules
#            rm -fr gui/union/.cache
#            rm -fr gui/union/node_modules
#            rm -fr lib/ts/base/node_modules
#            rm -fr lib/ts/material-ui/node_modules
      - run:
          command: |
            if [ ! -d ./node_modules ]; then
              npm install
            fi
            npm run lerna:bootstrap
      - run:
          name: Build
          command: |
            # lib build order matters
            cd lib/ts/base
            export PATH=$PATH:$PWD/node_modules/.bin
            npm run build
            cd ../models
            npm run build
            cd ../lunr
            npm run build
            cd ../material-ui
            npm run build
            cd ../material-ui-next
            npm run build
            cd ../../../gui/union
            export DATA_DIRECTORY_PATH=$PWD/data/test
            npm run build
            npm run export
            mkdir ~/dist
            mv out ~/dist/union-gui
      - save_cache:
          key: ts-cache-v4-{{ checksum "package.json" }}-{{ checksum "gui/union/package.json" }}-{{ checksum "lib/ts/base/package.json" }}-{{ checksum "lib/ts/material-ui/package.json" }}-{{ checksum "lib/ts/models/package.json" }}
          paths:
            - ~/.cache
            - ~/.npm
            - ./node_modules
            - ./gui/union/node_modules
            - ./lib/ts/base/node_modules
            - ./lib/ts/material-ui/node_modules
      - persist_to_workspace:
          root: ~/
          paths:
            - dist/union-gui
      - run:
          name: "Run GUI loader tests"
          command: |
            mkdir -p test-results
            cd etl
            pytest --junitxml=../test-results/etl.xml test/paradicms_etl_test/loaders/gui/gui_builder_test.py
      - store_test_results:
          path: test-results
orbs:
  cypress: cypress-io/cypress@1
workflows:
  version: 2
  build:
    jobs:
      - cypress/install:
          cache-key: 'cache-{{ arch }}-{{ .Branch }}-{{ checksum "~/project/package.json" }}-{{ checksum "~/project/gui/union/package.json" }}-{{ checksum "~/project/integration/union/package.json" }}-{{ checksum "~/project/lib/ts/base/package.json" }}-{{ checksum "~/project/lib/ts/material-ui/package.json" }}'
          post-install:
            - run: cd ~/project && npm install && npm run lerna:bootstrap
          requires:
            - ts
          working_directory: integration/union
      - cypress/run:
          attach-workspace: true
          post-steps:
            - store_test_results:
                path: integration/union/results
          requires:
            - cypress/install
          start: |
            cp ~/project/.circleci/cypress.json .
            ~/project/node_modules/.bin/serve -n ~/dist/union-gui
          store_artifacts: true
          wait-on: 'http-get://localhost:5000/index.html'
          working_directory: integration/union
      - py
      - ts
